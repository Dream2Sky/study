## 哨兵机制：检测和维护主库稳定的机制

### 哨兵的基本流程

1. ***监控***
    - **哨兵进程**会在运行时周期性的向主库发送`ping`命令, 判断主库是否下线。
    - 哨兵进程判断主库是否下线有两个阶段
        1. **主观下线**
            单个哨兵进程可能会有误判的情况，导致正常的主库被下线了。所以当一个哨兵进程判断主库下线时，只会标记成主观下线。
        2. **客观下线**
            由**哨兵集群**集体决策是否真的下线了。当集群中多个哨兵进程把主库标记为主观下线时，追随**少数服从多数**的原则。哨兵集群才会把主库标记成客观下线。
2. ***选主***
    - 过滤掉网络状况不好的，或者已经下线的从库，判断的依据就是统计主从库断连时间超过最大连接时间（`down-after-milliseconds`）的次数，过滤掉频率超过阈值（比如10次）的从库。
    - 然后再在剩下的从库中根据 **从库优先级** > **从库复制进度** > **从库ID号**的
        1. 从库
3. ***通知***
    哨兵会把新主库的连接信息发给其他从库，让它们执行 `replicaof` 命令，和新主库建立连接，并进行数据复制。同时，哨兵会把新主库的连接信息通知给客户端，让它们把请求操作发到新主库上。

![image](https://static001.geekbang.org/resource/image/ef/a1/efcfa517d0f09d057be7da32a84cf2a1.jpg)


## Pub/Sub 机制

哨兵之间是通过发布和订阅redis的`__sentinel__:hello`频道，来互相发现并建立连接的。

redis提供了许多的频道给外部应用来发布消息和订阅信息。

    当一个哨兵实例和主库之间建立连接之后，会订阅`__sentinel__:hello`这个频道，同时在上面发布自己的连接信息。然后后面的有其他的哨兵实例跟主库也建立连接的话就可以获取到其他哨兵实例的信息，这样哨兵集群就建立起来了。

### 哨兵如何和从库建立连接

哨兵实例在连接到主库之后会向主库发送 `INFO` 命令，然后主库会向哨兵发送从库列表。
![image](https://static001.geekbang.org/resource/image/88/e0/88fdc68eb94c44efbdf7357260091de0.jpg)

每个哨兵实例同时也会启用Pub/Sub机制，客户端可以向哨兵订阅消息。

哨兵提供的消息订阅频道有很多，不同频道包含了主从库切换过程中的不同关键事件。

**关键事件**
![image](https://static001.geekbang.org/resource/image/4e/25/4e9665694a9565abbce1a63cf111f725.jpg)

### 哨兵Leader决策

![image](https://static001.geekbang.org/resource/image/e0/84/e0832d432c14c98066a94e0ef86af384.jpg)

任何一个实例只要自身判断主库“**主观下线**”后，就会给其他实例发送 `is-master-down-by-addr` 命令。接着，其他实例会根据自己和主库的连接情况，做出 Y 或 N 的响应，Y 相当于赞成票，N 相当于反对票。

一个哨兵获得了仲裁所需的赞成票数后，就可以标记主库为“**客观下线**”。这个所需的赞成票数是通过哨兵配置文件中的 `quorum` 配置项设定的。

### Leader 投票

任何一个想成为 Leader 的哨兵，要满足两个条件：
第一，拿到半数以上的赞成票；
第二，拿到的票数同时还需要大于等于哨兵配置文件中的 `quorum` 值。