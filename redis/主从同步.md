### redis 具有高可靠性体现在什么地方？
1. 数据尽量少丢失
    用AOF和RDB保证在宕机时尽量少的丢失，同时可以快速恢复数据
2. 服务尽量少中断
    采用增加副本冗余的方式，即主从库模式。

***==为了保证主从库数据一致，redis采用读写分离的模式。==***

- 读操作： 主库和从库都可以接收
- 写操作： 只有主库接收， 然后同步数据到各个从库

## redis 主从库数据同步过程

***1. 建立连接，完成第一次数据同步***

    - 第一阶段：
    - 从库通过`replicaof 主库ip 端口`命令向主库发送连接申请。
    - 此时从库会向主库发送 `psync ?(runID, 第一次同步，不知道主库的runID,所以会传?) -1(offset)` 指令给主库

    - 第二阶段：
    - 主库接受到指令之后就会向从库发送 `FULLERSYNC rundID offset`, 表示做好全量同步的准备，同时告诉从库，主库的runID和复制进度。
    - 主库发送RDB文件给从库，从库依照这个RDB文件来进行数据恢复。

    - 第三阶段：
    - 主库将在创建和传输RDB文件这段时间内的新收到的命令，即`replication buffer` 发送给从库，然后从库执行`replication buffer`的命令更新数据，完成第一次数据同步。

![image](https://static001.geekbang.org/resource/image/63/a1/63d18fd41efc9635e7e9105ce1c33da1.jpg)

在第一次做数据同步时，如果此时有比较多的从库都需要全量同步，就会造成主库比较大的性能消耗。所以这种情况下，可以采用 `主 - 从 - 从` 的连接方式，减少主库的压力。
![image](https://static001.geekbang.org/resource/image/40/45/403c2ab725dca8d44439f8994959af45.jpg)

***2. 主从建立长连接***

一旦主从库完成了全量复制，它们之间就会一直维护一个网络连接，主库会通过这个连接将后续陆续收到的命令操作再同步给从库，这个过程也称为基于长连接的命令传播，可以避免频繁建立连接的开销。

***3. 用增量复制的机制恢复主从库之间因网络问题导致的数据不一致问题***

    - redis在写命令的时候会写入到一个叫 `repl_backlog_buffer` 的缓冲区里面。`repl_backlog_buffer`缓冲区是一个环形缓冲区。主库会记录写的位置，从库会记录读到的位置。

    - 在网络断开重连之后，从库会通过`psync`命令把自己的slave_repl_offset发送给主库，然后主库判断自己的master_repl_offset和slave_repl_offset之间的差距。
    
    - 如果主库的写操作覆盖了从库还未读取的命令时，此时主从之间就会直接做全量的同步工作。如果没有则只需要把slave_repl_offset刀master_repl_offset之间的内容同步即可。